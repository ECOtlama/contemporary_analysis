---
title: "curation_notation_file_gff3"
output: html_document
---


# Curation of gff3 notation file & Diversity calculus per diversity units

It is based in several scripts:

Dviersity calculus per unit (inmmunocapture elena's folder) 18/11/2016
modif_per_unit
promoters
telomers
subtelomeric-centromeric_filtering.R
plotting_subtelomeric_region(...).Rmk

Create an input bedfile that contains all the features we are interested in:

Asumimos ( mirando el archivo ) que es uno based.We are in server a.


```{r, engine=bash, eval=FALSE}

cd /GRUPOS/grupolince/Lyp_annotation_Apr14_final

# I create a folder and store there everything that is older as we want to run this script again:
# mkdir /home/mlucena/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/maria_curation
# Now it is finally removed!
```

## 1. Get a non-redundant (i.e., just the main isoform- and its CDS and exons- per gene) gff3.

```{r, engine=bash, eval=FALSE}

cat <(cut -f 2 /home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/Anotacion_PrincipaIsoforms_Nando/genes2transcript.nr.list | awk '{print $1";"}' ) <(echo -e "EVM_PASA\tgene") | grep -f - /GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/LYPA23C.all.fix.gff3 | sed 's/^\(.\{4\}\)/\1./' > /GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/LYPA23C.all.fix.nr.gff3 

# Al usar "EVM_PASA\tgene" podemos seleccionar todos los genes y no solo aquellos que están en el file de la isoforma principal. Esto pasaría por ejemplo para genes que sólo tengan una isoforma.

```

---> Sanity check: They are OK! 

How many genes are not in genes2transcript.nr.list file and are in my file? 

```{r, engine=bash, eval=FALSE}

diff <(cut -f 9 /home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/LYPA23C.all.fix.nr.gff3 | awk '{split ($0,a,"="); split (a[2],b,"T"); print b[1]}' | grep -v '^$' | sort | uniq | grep "LYPA" | sed 's/> //g') <(grep -v '^###$' /home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/LYPA23C.all.fix.gff3 | awk '{split ($0,a,"="); split (a[2],b,"T"); print b[1]}' | grep -v '^$' | sort | uniq | grep -v "lnc" | grep "LYPA" | sed 's/> //g')
## NONE!
```



---> Sanity check para comprobar si la longitud de los mRNA y de los genes es igual o no. 
```{r, engine=bash, eval=FALSE}

while read GENEID ;
do
echo "$GENEID"
grep "$GENEID" LYPA23C.all.fix.nr.gff3 | grep -P 'EVM_PASA\tgene' | awk -v OFS='\t' '{print $4,$5}' > temp.gene.to.merge.borrar
grep "$GENEID" LYPA23C.all.fix.nr.gff3 | grep -P 'EVM_PASA\tmRNA' | awk -v OFS='\t' '{print $4,$5,$7}' > temp.mRNA.to.merge.borrar
paste <(echo $GENEID) <(cat temp.gene.to.merge.borrar ) <(cat temp.mRNA.to.merge.borrar) >> GENE_vs_mRNA1.borrar
done < <( zcat /home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/APPRIS/p23A.v3.14Oct2013/appris_data.corsair.lynx_pardinus.gff3.gz |  awk '$6>3 {  print $0 }' | awk '{ split($0,a,"Parent="); print a[2] }' | sort | uniq |  tr -d '"' | sed 's/LYPA23A/LYPA23C/g' )
 

echo -e "GENE\tGENEstart\tGENEend\tmRNAstart\tmRNAend\tsense" > header.borrar
cat header.borrar GENE_vs_mRNA1.borrar > GENE_vs_mRNA
rm GENE_vs_mRNA1.borrar

cat GENE_vs_mRNA | awk '{if ($6=="+") print $1,$2,$3,$4,$5,$4-$2,$6; else print $1,$2,$3,$4,$5,$3-$5,$6}' | grep -v " 0 +" | grep -v " 0 -" > GENE_vs_mRNA_not_coincident.csv

# Ordenamos para ver si hay mRNA más grandes que el gen

sort -nk 6,6 GENE_vs_mRNA_not_coincident.csv | head

LYPA23C009331 951644 1073145   1073145 
LYPA23C011646 1257920 1266478   1266478 
LYPA23C003666 508377 661952 508378 661952 1 +
LYPA23C006676 105603 123366 105604 123366 1 +
LYPA23C007565 165681 184310 165682 179940 1 +
LYPA23C008484 281592 436862 281593 436862 1 +
LYPA23C010147 409727 424659 409727 424658 1 -

# Vemos que hay dos genes que no han salido bien las cuentas: ¿Qué ha pasado? Lo que ha pasdo esque como restamos $4-$2, como la columna 2 tenía un valor se ha repetido de nuevo. De todos modos amos genes, están solo definidos como genes y no como mRNA. 

# ex.
grep LYPA23C011646 LYPA23C.all.fix.nr.gff3
lp23.s36500	EVM_PASA	gene	1257920	1266478	.	-	.	ID=LYPA23C011646

sort -nk 6,6 GENE_vs_mRNA_not_coincident.csv | tail

LYPA23C022341 2453896 2612651 2453896 2528534 84117 -
LYPA23C003536 95103 204860 95103 120325 84535 -
LYPA23C002911 412515 544333 412515 458827 85506 -
LYPA23C012269 550100 751240 550100 663083 88157 -
LYPA23C006999 47661 177299 47661 87628 89671 -
LYPA23C010193 42335 245145 42335 143884 101261 -
LYPA23C018690 774342 989373 774342 879936 109437 -
LYPA23C010854 2554 210393 137923 210393 135369 +
LYPA23C012216 3753370 4070238 3910256 4070238 156886 +

# Esto significa que hay genes definidos que son 1 base más larga que el mRNA pero también hay genes definidos que tienen hasta 156886 bases más. 
# Esto lo tenemos que tener en cuenta para lo UTR. 


rm *borrar
```
They are not always coincident, the file is called: "GENE_vs_mRNA_not_coincident.csv". What then?





## 2. Get the features represented in the bedfile

```{r, engine=bash, eval=FALSE}

cut -f 3 /home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/LYPA23C.all.fix.nr.gff3  | sort | uniq

# CDS
# exon
# gene
# mRNA

```

## 3. Get the features not represented (i.e., promoters, introns, 5'UTR and 3'UTR, lncRNA & ncRNA, intergenic) 

La estructura que queremos es SCAFFOLD EVM_PASA FEATURE START END POINT STRANDNESS FRAME IDRAW

### 3.a. Gene promoters. 

- Vamos a usar sólo la lista de los genes que están completos en toda su longitud filtrado desde el archivo generado con APPRIS

- Lista de genes que nos interesan, son los genes que están en appris_data.corsair.lynx_pardinus.gff3.gz y tienen una puntuación mayor que 3 en la 6th columna. Escogemos este corte porque:

Email Michael Trees: 
Si quieres sacar datos ya el fichero correcto es appris_data.corsair.lynx_pardinus.gff3.
Aparte del gen y transcrito lo importante seria el score de CORSAIR, que es la
columna justo despues de las coordinadas. Como lo hemos calculado
entonces habia un punto para cada especia alineado corectamente (aunque
perro valia 0.8, pollo 2, xenopus 2 y danio 2.5. Entonces para asegurar
que han alineado bien proteinas al menos dos especies (y asi es menos
probable que el isoforma ha alineado contra fragmentos) pondria un corte de tres.
lp23.s10430	3817466	3817966	PROMOTER:LYPA23C008622T2	0	+


- No usamos la lista de Fede porque gracias a algunos sanity checks comprobé que al menos un promotor solapaba con un gen (si quieres saber cómo lo supe: script antiguo). Tras hablar con Fede, nos ha confirmado que para la dirección - los promotores no están bien definidos, por tanto vamos a volver a definirlos nosotros desde el principio. 

Como los tenemos que definir de nuevo, los vamos a definir en base a una lista de 250, 500 y 1000bp. 

```{r, engine=bash, eval=FALSE}

rm LYPA23C.promoters_full_length_genes.nr.250bp.gff3
rm LYPA23C.promoters_full_length_genes.nr.500bp.gff3
rm LYPA23C.promoters_full_length_genes.nr.1000bp.gff3
while read GENEID ;
do

echo "$GENEID 250"
grep "$GENEID" LYPA23C.all.fix.nr.gff3 | grep -P 'EVM_PASA\tmRNA'  | \
awk -v OFS='\t' '{split($0,a,":"); if ($7=="+") print $1,"manual","promoter_gene_250",$4-251,$4-1,$6,$7,$8,$9"_promoter"; else print $1,"manual","promoter_gene_250",$5+1,$5+251,$6,$7,$8,$9"_promoter"}'>> LYPA23C.promoters_full_length_genes.nr.250bp.gff3

echo "$GENEID 500"
grep "$GENEID" LYPA23C.all.fix.nr.gff3 | grep -P 'EVM_PASA\tmRNA'  | \
awk -v OFS='\t' '{split($0,a,":"); if ($7=="+") print $1,"manual","promoter_gene_500",$4-501,$4-1,$6,$7,$8,$9"_promoter"; else print $1,"manual","promoter_gene_500",$5+1,$5+501,$6,$7,$8,$9"_promoter"}'>> LYPA23C.promoters_full_length_genes.nr.500bp.gff3

echo "$GENEID 1000"
grep "$GENEID" LYPA23C.all.fix.nr.gff3 | grep -P 'EVM_PASA\tmRNA'  | \
awk -v OFS='\t' '{split($0,a,":"); if ($7=="+") print $1,"manual","promoter_gene_1000",$4-1001,$4-1,$6,$7,$8,$9"_promoter"; else print $1,"manual","promoter_gene_1000",$5+1,$5+1001,$6,$7,$8,$9"_promoter"}'>> LYPA23C.promoters_full_length_genes.nr.1000bp.gff3

done < <( zcat APPRIS/p23A.v3.14Oct2013/appris_data.corsair.lynx_pardinus.gff3.gz |  awk '$6>3 {  print $0 }' | awk '{ split($0,a,"Parent="); print a[2] }' | sort | uniq |  tr -d '"' | sed 's/LYPA23A/LYPA23C/g')


# Me he dado cuenta haciendo un sanity check que los promotores pueden ir más alla del 0 al restar a un numero 250 500 o 1000. Por tanto lo voy a modificar para que esas posiciones empiecen en 1. 


# ############ ----> Sanity_check:
# # Todos los que son menores que 0 al restarle el promotor deben caer en genes +
# rm *borrar*
# for promoters_gene_list in LYPA23C.promoters_full_length_genes.nr*
# do
# awk -v OFS='\t' '{if ($4<0) print $0}' $promoters_gene_list | sort -nk 4,4 > ${promoters_gene_list/.nr./.borrar.}
# done
# for i in *borrar*
# do
# echo $i"--->+"
# grep "$(echo -e '\t+\t')" $i | wc -l 
# echo $i"--->-"
# grep "$(echo -e '\t-\t')" $i | wc -l 
# done
# 
# # LYPA23C.promoters_full_length_genes.borrar.1000bp.gff3--->+ 13
# # LYPA23C.promoters_full_length_genes.borrar.1000bp.gff3--->- 0
# # LYPA23C.promoters_full_length_genes.borrar.250bp.gff3--->+ 9
# # LYPA23C.promoters_full_length_genes.borrar.250bp.gff3--->- 0
# # LYPA23C.promoters_full_length_genes.borrar.500bp.gff3--->+ 10
# # LYPA23C.promoters_full_length_genes.borrar.500bp.gff3--->- 0  
# # ok!!
# # Por otro lado, todos los que se escapan por el otro lado deben ser más grandes que el scaffold:
# # Todos deben caer en genes -.
# rm *borrar*
# for promoters_gene_list in LYPA23C.promoters_full_length_genes.nr*
# do
# join -1 1 -2 1 <(cat /GRUPOS/grupolince/reference_genomes/lynx_pardinus_genome/Length_scaffolds_lp23) <(LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n $promoters_gene_list) | awk -v OFS='\t' '{print $0, $2-$6}' | sort -nk 11,11 | awk -v OFS='\t' '{if ($11<0) print $0}' | tr ' ' '\t' > ${promoters_gene_list/.nr./.borrar.}
# done
# for i in *borrar*
# do
# echo $i"--->+"
# grep "$(echo -e '\t+\t')" $i | wc -l 
# echo $i"--->-"
# grep "$(echo -e '\t-\t')" $i | wc -l 
# done
# rm *borrar*
# # LYPA23C.promoters_full_length_genes.borrar.1000bp.gff3--->+0
# # LYPA23C.promoters_full_length_genes.borrar.1000bp.gff3--->-18
# # LYPA23C.promoters_full_length_genes.borrar.250bp.gff3--->+0
# # LYPA23C.promoters_full_length_genes.borrar.250bp.gff3--->-9
# # LYPA23C.promoters_full_length_genes.borrar.500bp.gff3--->+0
# # LYPA23C.promoters_full_length_genes.borrar.500bp.gff3--->-13
# # ok!!
##############

# Lo corrijo: 

# Para los que caen más allá del cero:

for promoters_gene_list in LYPA23C.promoters_full_length_genes.nr*
do
echo $promoters_gene_list
echo `wc -l $promoters_gene_list`
awk -v OFS='\t'  '{if ($4<0) print $1,$2,$3,"1",$5,$6,$7,$8,$9; else print $0}' $promoters_gene_list | awk -v OFS='\t' '$5!=0 && $5!=1 {print $0}' | LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n > ${promoters_gene_list/.nr./.fix.}
echo `wc -l ${promoters_gene_list/.nr./.fix.}`
done

# LYPA23C.promoters_full_length_genes.nr.1000bp.gff3
# 7394 LYPA23C.promoters_full_length_genes.nr.1000bp.gff3
# 7391 LYPA23C.promoters_full_length_genes.fix.1000bp.gff3
# LYPA23C.promoters_full_length_genes.nr.250bp.gff3
# 7394 LYPA23C.promoters_full_length_genes.nr.250bp.gff3
# 7391 LYPA23C.promoters_full_length_genes.fix.250bp.gff3
# LYPA23C.promoters_full_length_genes.nr.500bp.gff3
# 7394 LYPA23C.promoters_full_length_genes.nr.500bp.gff3
# 7391 LYPA23C.promoters_full_length_genes.fix.500bp.gff

# Compruebo que efectivamente son tres, y por tanto reemplazo el archivo.

for promoters_gene_list in LYPA23C.promoters_full_length_genes.nr*
do
mv ${promoters_gene_list/.nr./.fix.} $promoters_gene_list
done


# Tengo que comprobar que nos se nos escapa tampoco por el otro lado:

# Aquí lo imprimimos bien. Si su terminación real cae dentro del scaffold se imprime esta terminación y si no, el final del scaffold. 

for promoters_gene_list in LYPA23C.promoters_full_length_genes.nr*
do
echo $promoters_gene_list
join -1 1 -2 1 /GRUPOS/grupolince/reference_genomes/lynx_pardinus_genome/Length_scaffolds_lp23 $promoters_gene_list | tr ' ' \\t | awk -v OFS='\t' '($5<$2) {print $0}' | 
awk -v OFS='\t' '{ if ($6<$2) print $1,$3,$4,$5,$6,$7,$8,$9,$10 ; else print $1,$3,$4,$5,$2,$7,$8,$9,$10 }' > ${promoters_gene_list/.nr./.fix.} # con el primer awk me quito todos aquellos que empiecen más alla del fin del scaffold. con el segundo awk todos los que acaben más alla del fin del scaffold 
awk -v OFS='\t' '{print $5-$4}' ${promoters_gene_list/.nr./.fix.} | sort -n > ${promoters_gene_list/.nr./.borrar.} # con este archivo luego comprobamos que la resta está bien hecha.  
done

###### ----> Sanity check
# for i in *borrar*
# do
# head -n 50 $i
# done
######

rm *borrar*

for promoters_gene_list in LYPA23C.promoters_full_length_genes.nr*
do
echo "${promoters_gene_list/.nr./.fix.} ----> $promoters_gene_list"
mv ${promoters_gene_list/.nr./.fix.} $promoters_gene_list
done

## todo perfecto!
  
```



### 3.b. Introns 

---> Sanity check para comprobar que es seguro usar el bed de Fede.


```{r, engine=bash, eval=FALSE}

# Comprobar que están bien calculados con algún ej a ojo. Tomo para el ejemplo los 10 primeros genes
grep gene LYPA23C.all.fix.nr.gff3 | head | awk '{ split($0,a,"ID="); print a[2] }'

GENES=('LYPA23C013748' 'LYPA23C013847' 'LYPA23C013736' 'LYPA23C013679' 'LYPA23C013712' 'LYPA23C013832' 'LYPA23C013840' 'LYPA23C013755' 'LYPA23C013826' 'LYPA23C013809')
rm check.introns.borrar
for GENEID in "${GENES[@]}"
do
echo "---------------------GENE = $GENEID---------------------------" >> check.introns.borrar
grep "ID=$GENEID" LYPA23C.all.fix.nr.gff3 | grep gene  >> check.introns.borrar
echo "---------------------EXONS---------------------------" >> check.introns.borrar
grep "$GENEID" LYPA23C.all.fix.nr.gff3 | grep exon  >> check.introns.borrar
echo "---------------------INTRONS---------------------------" >> check.introns.borrar
grep "ID=$GENEID" LYPA23C.introns.nr.gff3 | grep intron  >> check.introns.borrar
echo >> check.introns.borrar
echo >> check.introns.borrar
done
 
# Hemos comprobado que tenemos definidos intrones para menos genes de los que hay. Comprobamos que estos genes en cuestión no tienen más de un exón y por tanto no tienen intrones definidos.

rm exon_per_genes_in_my_nr_file_and_not_in_introns_bed.list
while read GENE;
do 
echo $GENE
grep $GENE /home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/LYPA23C.all.fix.nr.extra.genes.gff3 | grep -e $'\t''EVM_PASA'$'\t''CDS'$'\t' | awk '{split ($9,a,";"); print a[1]}' | uniq -c | sort -k1,1 | grep -v "1 Parent" >> CDS_per_genes_in_my_nr_file_and_not_in_introns_bed.list
done < <(cat genes_in_my_nr_file_and_not_in_introns_bed.list)

# Hablando con Fede y me ha comentado "Sólo he mirado el primero y el segundo. El intrón del gen LYPA23C001262 solapa con el UTR de otro gen. Por eso no se considera intrón “puro”. Lo mismo pasa con el segundo. Los genomas son muy raros ;-)". Por tanto estos intrones no se considerarían. 

```
Tras discutir con Fede las dudas que tenías vemos que los intrones están bien, solo tendríamos que corregir que están como 0based y nosotros queremos pasarlo a 1 based para el gff. 

```{bash}
También comprobamos que sólo están las principales isoformas y así es:
awk '{split ($4,a, ":"); print a[2] }'  /home/fabascal/FEATURES/introns.bed |  sort | uniq -c
```

Corregimos a 0 based:

```{r, engine=bash, eval=FALSE}
awk -v OFS='\t' '{split($4,a,":"); print $1,"MANUAL","intron",$2+1,$3,".",$6,$5,"ID="a[2]}' /home/GRUPOS/grupolince/copia_fabascal/FEATURES/introns.bed | awk -v OFS='\t' '{if ($9==prev) counter++; else counter=1; print ($1,$2,$3,$4,$5,$6,$7,$8,$9"_intron_"counter); prev=$9}'  > LYPA23C.introns.nr.gff3
```

### 3.c. UTRs

For each gene

Vamos a usar sólo la lista de los genes que están completos en toda su longitud filtrado desde el archivo generado con APPRIS

Lista de genes que nos interesan, son los genes que están en appris_data.corsair.lynx_pardinus.gff3.gz y tienen una puntuación mayor que 3 en la 6th columna. Escogemos este corte porque:

Email Michael Trees: 
Si quieres sacar datos ya el fichero correcto es appris_data.corsair.lynx_pardinus.gff3.
Aparte del gen y transcrito lo importante seria el score de CORSAIR, que es la
columna justo despues de las coordinadas. Como lo hemos calculado
entonces habia un punto para cada especia alineado corectamente (aunque
perro valia 0.8, pollo 2, xenopus 2 y danio 2.5. Entonces para asegurar
que han alineado bien proteinas al menos dos especies (y asi es menos
probable que el isoforma ha alineado contra fragmentos) pondria un corte de tres.

Las UTR se podrían definir como gene-exon,gene-cds y exon-cds. Tras discutir cual es la mejor aproximación, nos vamos a quedar con gene-cds

```{r, engine=bash, eval=FALSE}

rm LYPA23C.UTRs_gene-cds.nr.gff3
while read GENEID ;
do
echo "$GENEID" 
# gene
grep "$GENEID" /GRUPOS/grupolince/Lyp_annotation_Apr14_final/LYPA23C.all.fix.nr.gff3   | # Solo si uso el file con todas las isoformas sed 's/^\(.\{4\}\)/\1./'  | \
grep -e $'\t''EVM_PASA'$'\t''gene'$'\t' | awk -v OFS='\t' '{print $1,$2,$3,$4-1,$5,$6,$7,$8,$9}' \
> gene.iter.bed.borrar
# He convertido el archivo en 0-based para hacer el substract. 
# cds
grep "$GENEID" /GRUPOS/grupolince/Lyp_annotation_Apr14_final/LYPA23C.all.fix.nr.gff3  | # Solo si uso el file con todas las isoformassed 's/^\(.\{4\}\)/\1./'  | \
grep -e $'\t''EVM_PASA'$'\t''CDS'$'\t' | \
awk -v OFS='\t' 'NR == 1 {min = $4} NR>1 && $4<min {min = $4}; NR == 1 {max = $5} NR>1 && $5>max {max = $5} END {print  $1,min-1,max}'  \
> cds.iter.bed.borrar
# He convertido el archivo en 0-based para hacer el substract. 
# Get UTRs by doing gene-exon, gene-cds and exon-cds:
bedtools subtract -a gene.iter.bed.borrar -b cds.iter.bed.borrar > gene-cds.iter.bed.borrar
# Get UTRs
awk -v OFS='\t' 'NR==1 {if ($7=="+") print $1,$2,"5UTR",$4,$5,$6,$7,$8,$9,$5-$4 ; else print $1,$2,"3UTR",$4,$5,$6,$7,$8,$9,$5-$4} \
NR==2 {if ($7=="+") print $1,$2,"3UTR",$4,$5,$6,$7,$8,$9,$5-$4; else print $1,$2,"5UTR",$4,$5,$6,$7,$8,$9,$5-$4 }' gene-cds.iter.bed.borrar | \
awk -v OFS='\t' '$10>1 {print $1,$2,$3,$4+1,$5,$6,$7,$8,$9}' >>  LYPA23C.UTRs_gene-cds.nr.gff3  
# Lo que hace es quitarme todos los UTR que sean de un tamañao de 1 o 0. Además lo hago 1-based. 
done < <( zcat /GRUPOS/grupolince/Lyp_annotation_Apr14_final/APPRIS/p23A.v3.14Oct2013/appris_data.corsair.lynx_pardinus.gff3.gz |  awk '$6>3 {  print $0 }' | awk '{ split($0,a,"Parent="); print a[2] }' | sort | uniq |  tr -d '"' | sed 's/LYPA23A/LYPA23C/g')

# Este fallo se debe a que gene es igual a cds. 
# Error: Invalid record in file gene.iter.bed.borrar. Record is 
# lp23.s26762	EVM_PASA	gene	0	1635	.	-	.	ID=LYPA23C003834

# También se podría hacer como gene-exon o exon-cds. Esas combinaciones están en script antiguo. 
# Esto te daría 1-based directamente.

rm *.iter.bed.borrar

```

---> Sanity check para comprobar la longitud de los UTRs. 
```{r, engine=bash, eval=FALSE}

# Efectivamente como imaginabamos al hacer las cuentas gene - mRNA, hay UTR muy pequeños (de 1 base) hasta muy grandes. Aquí es incluso más dramático puesto que no es gene - mRNA sino gene - CDS. 

awk '{print $0,$5-$4}' LYPA23C.UTRs_gene-cds.nr.gff3  | sort -nk 10,10 | head

# lp23.s00346	EVM_PASA	5UTR	21453	21454	.	+	.	ID=LYPA23C020420 1
# lp23.s05474	EVM_PASA	5UTR	64682	64683	.	-	.	ID=LYPA23C017696 1
# lp23.s10489	EVM_PASA	5UTR	1054504	1054505	.	-	.	ID=LYPA23C009597 1
# lp23.s15671	EVM_PASA	5UTR	1956022	1956023	.	-	.	ID=LYPA23C022767 1
# lp23.s21030	EVM_PASA	5UTR	372327	372328	.	+	.	ID=LYPA23C020649 1
# lp23.s31313	EVM_PASA	5UTR	1885717	1885718	.	-	.	ID=LYPA23C017432 1
# lp23.s31393	EVM_PASA	5UTR	173018	173019	.	+	.	ID=LYPA23C019378 1
# lp23.s31562	EVM_PASA	5UTR	121955	121956	.	+	.	ID=LYPA23C007611 1
# lp23.s36556	EVM_PASA	5UTR	71669	71670	.	-	.	ID=LYPA23C015730 1
# lp23.s00065	EVM_PASA	5UTR	967477	967479	.	-	.	ID=LYPA23C022271 2

awk '{print $0,$5-$4}' LYPA23C.UTRs_gene-cds.nr.gff3  | sort -nk 10,10 | tail

# lp23.s31307	EVM_PASA	5UTR	587865	733709	.	+	.	ID=LYPA23C020193 145844
# lp23.s26098	EVM_PASA	5UTR	1161927	1311000	.	-	.	ID=LYPA23C010410 149073
# lp23.s10436	EVM_PASA	5UTR	72913	225062	.	+	.	ID=LYPA23C000428 152149
# lp23.s26073	EVM_PASA	5UTR	2999025	3153478	.	+	.	ID=LYPA23C022308 154453
# lp23.s00042	EVM_PASA	5UTR	249500	406004	.	-	.	ID=LYPA23C013118 156504
# lp23.s10505	EVM_PASA	5UTR	413463	570406	.	-	.	ID=LYPA23C023050 156943
# lp23.s36493	EVM_PASA	5UTR	3753370	3910352	.	+	.	ID=LYPA23C012216 156982
# lp23.s05347	EVM_PASA	5UTR	199934	369620	.	-	.	ID=LYPA23C021147 169686
# lp23.s10473	EVM_PASA	5UTR	937317	1122146	.	+	.	ID=LYPA23C019933 184829
# lp23.s36529	EVM_PASA	5UTR	217772	416565	.	+	.	ID=LYPA23C013936 198793


```


### 3.d. sncRNA


```{r, engine=bash, eval=FALSE}

# We have the final output of infernal package, and also a report explaining what we have. 
# The file is: infernal_1e6.gff3.zip  

sed 's/^\(.\{4\}\)/\1./' infernal_1e6.gff3 > infernal_1e6_fixed.gff3
mv infernal_1e6_fixed.gff3 LYPA23C.infernal_1e6_fixed.gff3

# This is not coming from a bed file, so I assumed that is 1-based


```



### 3.e. lncRNA

```{r, engine=bash, eval=FALSE}

# El archivo que tenemos es un archivo gtf que nos lo ha pasado Ionas Erb (Centre de Regulació Genòmica) de la última versión que hicieron del mismo. 
# El formato gtf es algo distinto a gff3. He encontrado un script de python que te los transforma y creo que ya los podríamos usar para lo que nos interesa.  

python /Users/marialucenaperez/Dropbox/PhD/contemporary/script/GTF_to_GFF3.py /Users/marialucenaperez/Desktop/lncRNAs_fixed.gtf > /Users/marialucenaperez/Desktop/lncRNAs_fixed.gff3
scp /Users/marialucenaperez/Desktop/lncRNAs_fixed.gtf GRUPOS@genomics-a.ebd.csic.es:///home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/
scp /Users/marialucenaperez/Desktop/lncRNAs_fixed.gff3 GRUPOS@genomics-a.ebd.csic.es:///home/GRUPOS/grupolince/Lynx_annotation/Lyp_annotation_Apr14_final/


sed 's/^\(.\{4\}\)/\1./' lncRNAs_fixed.gff3  | \
awk -v OFS='\t' '{split($9,a,";"); split (a[2],b,"\""); split ($11,c,"\""); print ($1,$2,$3,$4,$5,$6,$7,$8,b[1],c[2])}' | \
LANG=en_EN sort -k 9,9 -k 10,10 | \
awk -v OFS='\t' '{print ($1,$2,$3,$4,$5,$6,$7,$8,$9"_"$10)}' | \
awk -v OFS='\t' '{if ($9==prev) counter++; else counter=1; print ($1,$2,"lncRNA",$4,$5,$6,$7,$8,$9"_exon_"counter); prev=$9}' > lncRNAs_fixed_sorted.gff3 
mv lncRNAs_fixed_sorted.gff3 LYPA23C.lncRNAs_fixed_sorted.gff3


# This is not coming from a bed file, so I assumed that is 1-based

```


### 3.f. lncRNA introns

```{r, engine=bash, eval=FALSE}

rm LYPA23C.introns_lncRNA.gff3
rm cuentas.borrar
while read direction LNCRNA_ID ;
do
echo $LNCRNA_ID
grep "$LNCRNA_ID" LYPA23C.lncRNAs_fixed_sorted.gff3 | awk -v OFS='\t' '{print $1, $4, $5}' > exons.lncRNA.iter.borrar
wc -l exons.lncRNA.iter.borrar >> cuentas.borrar # To check if I should have more than an intron for a lncRNA. 
grep "$LNCRNA_ID" LYPA23C.lncRNAs_fixed_sorted.gff3 | \
awk -v OFS='\t' 'NR == 1 {min = $4} NR>1 && $4<min {min = $4}; NR == 1 {max = $5} NR>1 && $5>max {max = $5} END {print  $1,min,max}' > whole.lncRNA.iter.borrar
bedtools subtract -a whole.lncRNA.iter.borrar -b exons.lncRNA.iter.borrar > whole-exons.lncRNA.iter.bed.borrar
awk -v OFS='\t' '{print $1,"manual","intron_lncRNA",$2+1, $3-1,".","'${direction}'",".","GID='${LNCRNA_ID}'" }' whole-exons.lncRNA.iter.bed.borrar | awk -v OFS='\t' '{if ($9==prev) counter++; else counter=1; print ($1,$2,$3,$4,$5,$6,$7,$8,$9"_intron_"counter); prev=$9}'  >>  LYPA23C.introns_lncRNA.gff3
done < <( cat LYPA23C.lncRNAs_fixed_sorted.gff3| awk '{ split($0,a,"GID="); print $7, a[2] }' | awk '{ split($2,a,"_"); print $1, a[1]"_"a[2]"_"a[3]"_"a[4] }' | sort | uniq )
rm cuentas.borrar

```

### 3.g. lncRNA promoters

```{r, engine=bash, eval=FALSE}

rm LYPA23C.promoters_lncRNA.250bp.gff3
rm LYPA23C.promoters_lncRNA.500bp.gff3
rm LYPA23C.promoters_lncRNA.1000bp.gff3
while read LNCRNA_ID ;
do

echo "$LNCRNA_ID 250"
grep "$LNCRNA_ID" LYPA23C.lncRNAs_fixed_sorted.gff3 | \
awk -v OFS='\t' 'NR == 1 {min = $4} NR>1 && $4<min {min = $4}; NR == 1 {max = $5} NR>1 && $5>max {max = $5} END {print  $1,min,max,$7}' | 
awk -v OFS='\t' '{if ($4=="+") print $1,"manual","promoter_lncRNA_250",$2-251,$2-1,".",$4,".","GID='${LNCRNA_ID}'_promoter"; else print $1,"manual","promoter_lncRNA_250",$3+1,$3+251,".",$4,".","GID='${LNCRNA_ID}'_promoter"}' >> LYPA23C.promoters_lncRNA.250bp.gff3

echo "$LNCRNA_ID 500"
grep "$LNCRNA_ID" LYPA23C.lncRNAs_fixed_sorted.gff3 | \
awk -v OFS='\t' 'NR == 1 {min = $4} NR>1 && $4<min {min = $4}; NR == 1 {max = $5} NR>1 && $5>max {max = $5} END {print  $1,min,max,$7}' | 
awk -v OFS='\t' '{if ($4=="+") print $1,"manual","promoter_lncRNA_500",$2-501,$2-1,".",$4,".","GID='${LNCRNA_ID}'_promoter"; else print $1,"manual","promoter_lncRNA_500",$3+1,$3+501,".",$4,".","GID='${LNCRNA_ID}'_promoter"}' >> LYPA23C.promoters_lncRNA.500bp.gff3

echo "$LNCRNA_ID 1000"
grep "$LNCRNA_ID" LYPA23C.lncRNAs_fixed_sorted.gff3 | \
awk -v OFS='\t' 'NR == 1 {min = $4} NR>1 && $4<min {min = $4}; NR == 1 {max = $5} NR>1 && $5>max {max = $5} END {print  $1,min,max,$7}' | 
awk -v OFS='\t' '{if ($4=="+") print $1,"manual","promoter_lncRNA_1000",$2-1001,$2-1,".",$4,".","GID='${LNCRNA_ID}'_promoter"; else print $1,"manual","promoter_lncRNA_1000",$3+1,$3+1001,".",$4,".","GID='${LNCRNA_ID}'_promoter"}' >> LYPA23C.promoters_lncRNA.1000bp.gff3

done < <( cat LYPA23C.lncRNAs_fixed_sorted.gff3 | awk '{ split($0,a,"GID="); print a[2] }' | awk '{ split($0,a,"_"); print a[1]"_"a[2] }' | sort | uniq )


# Me he dado cuenta haciendo un sanity check que los promotores pueden ir más alla del 0 al restar a un numero 250 500 o 1000. Por tanto lo voy a modificar para que esas posiciones empiecen en 1. 


############ ----> Sanity_check:
# # Todos los que son menores que 0 al restarle el promotor deben caer en genes +
# rm *borrar*
# for promoters_lncRNA_list in LYPA23C.promoters_lncRNA*
# do
# echo $promoters_lncRNA_list
# awk -v OFS='\t' '{if ($4<0) print $0}' $promoters_lncRNA_list | sort -nk 4,4 > ${promoters_lncRNA_list/.gff3/.borrar.gff3}
# done
# for i in *borrar*
# do
# echo $i"--->+"
# grep "$(echo -e '\t+\t')" $i | wc -l
# echo $i"--->-"
# grep "$(echo -e '\t-\t')" $i | wc -l
# done
# 
# # LYPA23C.promoters_lncRNA.1000bp.borrar.gff3--->+32
# # LYPA23C.promoters_lncRNA.1000bp.borrar.gff3--->-0
# # LYPA23C.promoters_lncRNA.250bp.borrar.gff3--->+20
# # LYPA23C.promoters_lncRNA.250bp.borrar.gff3--->-0
# # LYPA23C.promoters_lncRNA.500bp.borrar.gff3--->+24
# # LYPA23C.promoters_lncRNA.500bp.borrar.gff3--->-0
# 
# # ok!!
# # Por otro lado, todos los que se escapan por el otro lado deben ser más grandes que el scaffold:
# # Todos deben caer en genes -.
# rm *borrar*
# for promoters_lncRNA_list in LYPA23C.promoters_lncRNA*
# do
# echo $promoters_lncRNA_list
# join -1 1 -2 1 <(cat /GRUPOS/grupolince/reference_genomes/lynx_pardinus_genome/Length_scaffolds_lp23) <(LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n $promoters_lncRNA_list) | awk -v OFS='\t' '{print $0, $2-$6}' | sort -nk 11,11 | awk -v OFS='\t' '{if ($11<0) print $0}' | tr ' ' '\t' > ${promoters_lncRNA_list/.gff3/.borrar.gff3}
# done
# for i in *borrar*
# do
# echo $i"--->+"
# grep "$(echo -e '\t+\t')" $i | wc -l
# echo $i"--->-"
# grep "$(echo -e '\t-\t')" $i | wc -l
# done
#   
# # LYPA23C.promoters_lncRNA.1000bp.borrar.gff3--->+0
# # LYPA23C.promoters_lncRNA.1000bp.borrar.gff3--->-30
# # LYPA23C.promoters_lncRNA.250bp.borrar.gff3--->+0
# # LYPA23C.promoters_lncRNA.250bp.borrar.gff3--->-22
# # LYPA23C.promoters_lncRNA.500bp.borrar.gff3--->+0
# # LYPA23C.promoters_lncRNA.500bp.borrar.gff3--->-26
# 
# # ok!!!
#############

# Lo corrijo: 

# Para los que caen más allá del cero:

rm *borrar*

for promoters_lncRNA_list in LYPA23C.promoters_lncRNA*bp.gff3
do
echo $promoters_lncRNA_list
echo `wc -l $promoters_lncRNA_list`
awk -v OFS='\t' '{if ($4<0) print $1,$2,$3,"1",$5,$6,$7,$8,$9; else print $0}' $promoters_lncRNA_list | awk -v OFS='\t' '$5!=0 && $5!=1 {print $0}' | LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n > ${promoters_lncRNA_list/bp./bp.fix.}
echo `wc -l ${promoters_lncRNA_list/bp./bp.fix.}`
done


# LYPA23C.promoters_lncRNA.1000bp.gff3
# 3182 LYPA23C.promoters_lncRNA.1000bp.gff3
# 3180 LYPA23C.promoters_lncRNA.1000bp.fix.gff3
# LYPA23C.promoters_lncRNA.250bp.gff3
# 3182 LYPA23C.promoters_lncRNA.250bp.gff3
# 3180 LYPA23C.promoters_lncRNA.250bp.fix.gff3
# LYPA23C.promoters_lncRNA.500bp.gff3
# 3182 LYPA23C.promoters_lncRNA.500bp.gff3
# 3180 LYPA23C.promoters_lncRNA.500bp.fix.gff3

# #### Sanity check --> ok
# awk '{print $5-$4}' LYPA23C.promoters_lncRNA.250bp.fix.gff3 | sort -n | head
# awk '{print $5-$4}' LYPA23C.promoters_lncRNA.500bp.fix.gff3 | sort -n | head
# awk '{print $5-$4}' LYPA23C.promoters_lncRNA.1000bp.fix.gff3 | sort -n | head
# #### 

# Compruebo que efectivamente son dos, y por tanto reemplazo el archivo.

for promoters_lncRNA_list in LYPA23C.promoters_lncRNA*bp.gff3
do
echo "${promoters_lncRNA_list/bp./bp.fix.} ---> $promoters_lncRNA_list"
mv ${promoters_lncRNA_list/bp./bp.fix.} $promoters_lncRNA_list
done

# Tengo que comprobar que nos se nos escapa tampoco por el otro lado:

# Aquí lo imprimimos bien. Si su terminación real cae dentro del scaffold se imprime esta terminación y si no, el final del scaffold. 

for promoters_lncRNA_list in LYPA23C.promoters_lncRNA*bp.gff3
do
echo $promoters_lncRNA_list
join -1 1 -2 1 /GRUPOS/grupolince/reference_genomes/lynx_pardinus_genome/Length_scaffolds_lp23 $promoters_lncRNA_list | tr ' ' \\t | awk -v OFS='\t' '($5<$2) {print $0}' | awk -v OFS='\t' '{ if ($6<$2) print $1,$3,$4,$5,$6,$7,$8,$9,$10 ; else print $1,$3,$4,$5,$2,$7,$8,$9,$10 }' > ${promoters_lncRNA_list/bp./bp.fix.} # con el primer awk me quito todos aquellos que empiecen más alla del fin del scaffold. con el segundo awk todos los que acaben más alla del fin del scaffold 
awk -v OFS='\t' '{print $5-$4}' ${promoters_lncRNA_list/bp./bp.fix.} | sort -n > ${promoters_lncRNA_list/bp./bp.fix.borrar.} # con este archivo luego comprobamos que la resta está bien hecha.  
done

###### ----> Sanity check
# for i in *borrar*
# do
# head -n 50 $i
# done
######

rm *borrar*

for promoters_lncRNA_list in LYPA23C.promoters_lncRNA*bp.gff3
do
echo "${promoters_lncRNA_list/bp./bp.fix.} ----> $promoters_lncRNA_list"
mv ${promoters_lncRNA_list/bp./bp.fix.} $promoters_lncRNA_list
done

## Todo perfecto!

```

#----------------------

## 4. Merging functional part of the genome 

Estos archivos los generé en sud ía y estan bien, pero como he añadido una nueva categoría funcional que son UCR lo he repetido y estos archivos los borré, aunque estaban bien. 
```{r, engine=bash, eval=FALSE}


# FUNCTIONAL FILE:
# Name: LYPA23C.CDS.EXON.GENE.mRNA.PROMOTERS.INTRONS.UTR.lncRNA.ncRNA.nr.gff3 

# Files included:
# 	1. Original file LYPA23C.all.fix.nr.gff3 (CDS/EXON/GENE/mRNA).
# 	(3.a.). Promoters
#           250
#           500
#           1000
# 	(3.b.) Introns.
# 	(3.c.) 5'UTR and 3'UTR (UTR es la región no traducida del gen: LYPA23C.UTRs_gene-cds.nr.gff3)
# 	(3.d.) sncRNA
# 	(3.e.) lncRNA
#   (3.f.) lncRNA introns 
#   (3.g.) lncRNA promoters
#           250
#           500
#           1000


# Como los exones son redundantes con los CDS porque tenemos UTR, los eliminamos del archivo all.fix.nr:
awk -v OFS='\t' '{if ($3!="exon") print $0}' LYPA23C.all.fix.nr.gff3 > LYPA23C.GENE.mRNA.CDS.fix.nr.gff3

# Podríamos también quitar mRNA o gene y dejar uno de los dos. Pero puesto que hemos comprobado que a veces son mucho más grandes los genes que el mRNA quizás sea interesante dejarlo. 

# Tenemos que tener claro entonces que los UTR pasan a ser gene-cds, teniendo en cuenta que gene-mRNA a veces da unos valores muy altos; como ya hemos comprobado, esto es especialmente dramático para gene-cds. Por lo que a veces los UTR serán enormes. 

# Este archivo tendría todo lo funcional.

cat LYPA23C.GENE.mRNA.CDS.fix.nr.gff3 LYPA23C.promoters_full_length_genes.nr.250bp.gff3 LYPA23C.promoters_full_length_genes.nr.500bp.gff3 LYPA23C.promoters_full_length_genes.nr.1000bp.gff3 LYPA23C.introns.nr.gff3 LYPA23C.UTRs_gene-cds.nr.gff3 LYPA23C.infernal_1e6_fixed.gff3 LYPA23C.lncRNAs_fixed_sorted.gff3 LYPA23C.introns_lncRNA.gff3 LYPA23C.promoters_lncRNA.250bp.gff3 LYPA23C.promoters_lncRNA.500bp.gff3 LYPA23C.promoters_lncRNA.1000bp.gff3 | LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3

```


---> Sanity check para comprobar que cada archivo tiene lo que se espera de él. 

```{r, engine=bash, eval=FALSE}


cut -f 3 LYPA23C.GENE.mRNA.CDS.fix.nr.gff3  | sort | uniq
cut -f 3 LYPA23C.promoters_full_length_genes.nr.250bp.gff3  | sort | uniq
cut -f 3 LYPA23C.promoters_full_length_genes.nr.500bp.gff3  | sort | uniq
cut -f 3 LYPA23C.promoters_full_length_genes.nr.1000bp.gff3  | sort | uniq
cut -f 3 LYPA23C.introns.nr.gff3  | sort | uniq
cut -f 3 LYPA23C.UTRs_gene-cds.nr.gff3  | sort | uniq
cut -f 3 LYPA23C.infernal_1e6_fixed.gff3  | sort | uniq
cut -f 3 LYPA23C.lncRNAs_fixed_sorted.gff3  | sort | uniq
cut -f 3 LYPA23C.introns_lncRNA.gff3  | sort | uniq
cut -f 3 LYPA23C.promoters_lncRNA.250bp.gff3  | sort | uniq
cut -f 3 LYPA23C.promoters_lncRNA.500bp.gff3  | sort | uniq
cut -f 3 LYPA23C.promoters_lncRNA.1000bp.gff3 | sort | uniq

# Salen todas bien!


cut -f 3 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3  | sort | uniq
# 3UTR
# 5UTR
# CDS
# gene
# intron
# intron_lncRNA
# lncRNA
# mRNA
# ncRNA
# promoter_gene_1000
# promoter_gene_250
# promoter_gene_500
# promoter_lncRNA_1000
# promoter_lncRNA_250
# promoter_lncRNA_500
# 
# Perfecto!



```

---> Sanity check para comprobar que cada archivo tiene lo que se espera de él. 

```{r, engine=bash, eval=FALSE}

# Miro a ver si nuestras construcciones ha provocado que algo se vaya más allá de cero. 

sort -nk 4,4 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3 | awk '($4<0){print $3}' | sort | uniq -c 
 
# OK!!! NADA! Esto es porque ya lo hemos solucionado con modificaciones del script arriba!!!


```

     
## 5. Defining intergenic regions

Fede tiene un bed de intergénico, pero dado que nosotros hemos:

1. Corregido los promotores que no estaban bien definidos para los genes -.
2. Añadido lncRNA (con promotores e intrones) y sncRNA

Por tanto, voy a usar mi file de funcional y restarle al genoma todas esas regiones. 

Vamos a construir dos tipos de regiones intergénicas:
1. Por un lado, tendríamos las regiones intergénicas que salen directamente de la resta del genoma menos la región funcional.
2. Por otro vamos a crear un intergénico que recoja las regiones que estén al menos a 1000pb de cualquier zona funcional. 


```{r, engine=bash, eval=FALSE}

# 1. 

# Por un lado, tendríamos las regiones intergénicas que salen directamente de la resta del genoma menos la región funcional.

# First create bed file based on the previous file. Como es un bed lo pasamos a es 0-based.

awk -v OFS='\t' '{print $1, $4-1, $5}' LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3 | bedtools merge -i stdin -d 1 > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed

#### ---> Sanity check:
# wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3
# 468341 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3
# [mlucena@genomics_b Lyp_annotation_Apr14_final]$ wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed
# 29799 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed
# ¡¡¡Solapan muchas cosas!!! Tambien tenemos que tener en cuenta que tenemos gene y mRNA que solapan, pero también promotores 250, 500 y 100 para genes y lncRNa que solapan también completamente. 
##### 

# Define intergenic region 1-based!!

bedtools subtract -a /home/mlucena/grupolince/reference_genomes/lynx_pardinus_genome/bed_file_all_the_genome.bed -b LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed > LYPA23C.intergenic.bed

# 2. 

# Por otro vamos a crear un intergénico que recoja las regiones que estén al menos a 1000pb de cualquier zona funcional. 
# First create bed file based on the previous file. Como es un bed lo pasamos a es 0-based.

# con este awk sustituyo la columna que yo quiero por un valor concreto y el resto lo dejo igual. 

awk -v OFS='\t' '{$4=$4-1000; $5=$5+1000; print}' LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3 > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.DO_NOT_USE.gff3

# Ojo! Este archivo es completamente artificial! Porque las unidades empiezan mil pares de bases antes de lo q deberían y acaban mil pares de bases despues, así que lo borro en cuanto lo use para no crear confusión. 

join -1 1 -2 1 <(cat /GRUPOS/grupolince/reference_genomes/lynx_pardinus_genome/Length_scaffolds_lp23)  <(LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.DO_NOT_USE.gff3) |  
awk -v OFS='\t' '{if ($5<0) {$5="1"} else {$5=$5}; print}' | awk -v OFS='\t' '{if ($6>$2) {$6=$2} else {$6=$6}; print $1,$5-1,$6}' | bedtools merge -i stdin -d 1 > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.DO_NOT_USE.bed

## Nota:Con este awk:
# awk -v OFS='\t' '{if ($5<0) {$5="1"} else {$5=$5}; print}' | awk -v OFS='\t' '{if ($6>$2) {$6=$2} else {$6=$6}; print $1,$5-1,$6}'
 # Lo que hago es mirar que nada se escape por debajo de 0 y si es así lo sustituyo por 1, lo que no se escapa se imprime igualmente. Además mira que nada sea más grande que el scaffold, y si es así, lo sustituyo por el valor de la longitud del scaffold, si no es más grande deja el mismo valor. En ambos casos, elimino del archivo el valor longitud de scaffold que está en columna 2 porque ya hemos hecho las comprobaciones que queremos. 
# También he guardado este archivito resultante de hacer estos awk e hice algunas comprobaciones. Concretamente miré que nada se escapaba por debajo de 0 en el límite superior y que nada se escapaba por encima de la longitud del scaffold. En definitiva, que el script funcionaba bien. 
# Este script además te imprime solo las columnas de las coordenadas en formato 0-based. 
# Si quisieras eliminar una columna, por ejemplo la 6: awk -v OFS='\t' '{if ($5<0) {$5="1"; $6=""} else {$5=$5; $6=""}; print}'

# Define strict intergenic region 1-based!!

bedtools subtract -a /home/mlucena/grupolince/reference_genomes/lynx_pardinus_genome/bed_file_all_the_genome.bed -b LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.DO_NOT_USE.bed > LYPA23C.intergenic.PLUS1000.bed

# I need to create also a gff3 file with the intergenic, even thought it can be contraintuitive to have so (as gff3 have only functional features), but I need it to do all the numbers. I will used LYPA23C.intergenic.PLUS1000.bed to be sure of using intergenic regions (therefore there should be 1000pb between any functional category and the intergenic region for each individual feature).

awk -v OFS='\t' '{print $1,"manual","intergenic",$2+1,$3,".", "-", ".", "ID=intergenic_region_" }' LYPA23C.intergenic.PLUS1000.bed | awk -v OFS='\t' '{if ($3==prev) counter++; else counter=1; print ($1,$2,$3,$4,$5,$6,$7,$8,$9counter); prev=$3}'  > LYPA23C.intergenic.PLUS1000.gff3

# Nota! solo para que no nos sorprenda, en el tail de este archivo me he dado cuenta que hay un montón de scaffolds que no tienen ninguna anotación y por tanto son completamente intergénicos:
# lp23.s41697	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65792
# lp23.s41698	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65793
# lp23.s41699	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65794
# lp23.s41700	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65795

rm *.DO_NOT_USE.*
```


## 6. Merging functional categories with intergenic gff3.


```{r, engine=bash, eval=FALSE}


# Now I merge it with the gff3 file.

cat LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3 LYPA23C.intergenic.PLUS1000.gff3 | LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 

```

  
## 7. Creating the DATASET for diversity and folder per scaffold to speed up the process when calculating diversity per unit. 

```{bash}

# First I create the dataset to do diversity calculus. I remove Gene and mRNA.

wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3
534123 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3

grep -v "EVM_PASA      gene" LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep -v "EVM_PASA        mRNA" | wc -l
491623

# I will compute way less sites, so I will use this file with no genes or mRNA. 
grep -v "EVM_PASA      gene" LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep -v "EVM_PASA  mRNA" > LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3



# Now I will separate it by scaffolds. 
mkdir LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3.PerScaffold
cd LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3.PerScaffold

# Create multiple files base on one column: gff3:
awk '{print >> $1; close($1)}' ../LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3


# Rename gff3.
for file in lp23*
do
echo $file
mv $file ${file/lp23/LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3_lp23}
done



```

# Ojo!!!! Corrección. Dos correcciones:

## Día 12/10/2017

Me he dado cuenta a posteriori de que algunos 5UTR estaban repetidos. 

README_corrected.gff3_file

Como estaba corriendo mis cuentas usando la carpeta per scaffold, lo dejé pasar, y luego lo he corregido a mano de mis resultados, y comprobado que es así el 12/10/2017. Este mismo día estoy corrigiendo todos los archivos anteriores por si alguna vez se utilizan. 

Como las features repetidas son UTR listo todo lo que tenga UTR:


```{bash}
ls *UTR*

LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.gff3
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.corrected.bed
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.corrected.gff3
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.bed
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.gff3
LYPA23C.UTRs_gene-cds.nr.gff3

```

Comando para ver si hay cosas repetidas:

```{bash}
# Archivos que ya tenían generado su archivo corrected:

i=LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.gff3 # --> Efectivamente corregido.
i=LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 # --> No corregido y lo elimino pq ya había generado su equivalente corregido

i=LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed # --> No corregido, eliminado.
i=LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.corrected.bed # --> Corregido, se guarda.

i=LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.corrected.gff3 # --> Corregido, se guarda.
i=LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3 # --> No corregido, eliminado.


# Archivos sin su archivo corrected generado:

i=LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3
i=LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3
i=LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.gff3
i=LYPA23C.UTRs_gene-cds.nr.gff3

sort $i | uniq -c | sort -nr | head
awk '!seen[$0]++' $i >  ${i/.nr./.nr.corrected.} 

# Archivos que genero:

LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.gff3
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.corrected.gff3
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.corrected.PLUS1000bp.gff3
LYPA23C.UTRs_gene-cds.nr.corrected.gff3


# Archivos que elimino:

rm LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3
rm LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3
rm LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.gff3
rm LYPA23C.UTRs_gene-cds.nr.gff3

# Además de esto, hay dos archivos bed que realmente están bien, porque al generarlos hice un merge. Por tanto aunque sean más antiguos, son de fiar. Estos archivos son:

LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.PLUS1000bp.bed

# Además de esto genero elimino la carpeta porScaffold para tner más sitio, pero si Elena o cualquier persona la necesitase, sólo tendría que crearla de nuevo con el siguiente script:

cd /GRUPOS/grupolince/Lyp_annotation_Apr14_final
mkdir LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.PerScaffold 
cd LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.PerScaffold


awk '{print >> $1; close($1)}' ../LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.gff3


# Rename gff3.
for file in lp23*
do
echo $file
mv $file ${file/lp23/LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.corrected.gff3_lp23}
done

```

## Día 12/10/2017


Haciendo comprobaciones me doy cuenta que hay varios asuntos que no están bien. 

En primer lugar hay varios UTR (tanto 5 como 3) que aparecen dos veces pero no son exactamente iguales y por eso no los ha eliminado el script de antes. La diferencia está en que uno es 0-based y otro 1-based.

En segundo lugar compruebo que algunas unidades empiezan en números negativos, y esto se debe a que creabamos un archivo PLUS1000 para sacar el intergénico que estabamos usando auqnue era totalemnte erroneo porque agrandaba las zonas funcionales 1000 pb. 


Para solucionar todo he vuelto a correr los UTR y comprobado que ya están bien. 

Esta es la lista que tenía más de uno y ya no lo tiene. 

2 5UTR LYPA23C000017 LYPA23C000017
2 5UTR LYPA23C000015 LYPA23C000015
2 5UTR LYPA23C000008 LYPA23C000008
2 3UTR LYPA23C000045 LYPA23C000045
2 3UTR LYPA23C000041 LYPA23C000041
2 3UTR LYPA23C000003 LYPA23C000003
      
```{bash}


grep LYPA23C000017 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s26402	EVM_PASA	5UTR	73114	73122	.	+	.	ID=LYPA23C000017
# lp23.s26402	EVM_PASA	3UTR	92633	95884	.	+	.	ID=LYPA23C000017

grep LYPA23C000017 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s26402	EVM_PASA	5UTR	73114	73122	.	+	.	ID=LYPA23C000017
# lp23.s26402	EVM_PASA	3UTR	92633	95884	.	+	.	ID=LYPA23C000017

grep LYPA23C000015 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s36682	EVM_PASA	5UTR	252655	252723	.	+	.	ID=LYPA23C000015
# lp23.s36682	EVM_PASA	3UTR	279677	279811	.	+	.	ID=LYPA23C000015

grep LYPA23C000008 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s36682	EVM_PASA	5UTR	329118	329217	.	+	.	ID=LYPA23C000008
# lp23.s36682	EVM_PASA	3UTR	338697	338929	.	+	.	ID=LYPA23C000008

grep LYPA23C000045 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s10719	EVM_PASA	3UTR	127698	128105	.	-	.	ID=LYPA23C000045
# lp23.s10719	EVM_PASA	5UTR	156260	156378	.	-	.	ID=LYPA23C000045

grep LYPA23C000041 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s10719	EVM_PASA	3UTR	85593	86080	.	-	.	ID=LYPA23C000041
# lp23.s10719	EVM_PASA	5UTR	96754	96794	.	-	.	ID=LYPA23C000041

grep LYPA23C000003 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 | grep UTR
# lp23.s36682	EVM_PASA	3UTR	320799	321993	.	-	.	ID=LYPA23C000003
# lp23.s36682	EVM_PASA	5UTR	328523	328962	.	-	.	ID=LYPA23C000003


# Perfecto!
```
      
En segundo lugar también modifico todos los archivos que se generen a partir de ahí. Y además el archivo con los 1000pb aumentados por ambos extremos lo elimino por completo para que no de pie a confusión. 

He copiado los archivos correctos en backup. 

De todas formas para que quede constancia hemos observado que hay varios ncRNA y esto se debe a que estos se seleccionaron en base a un evalue, así que dos secuencias a podido dar hit al mismo ncRNA con un evalue relativamente alto y por tanto las dos han pasado el filtro. 

# Ultra-conserved-regions

Voy a añadir a mi archivo de notación las ultraconserved regions. Estas UCR se han sacado basandonos en una base de datos online con coordenadas para humano que hemos traducido a gato y posteriormente a lince. Para más información, leer el script: ultra_conserved_regions. 

Ahora voy a pasar a añadirlas en mi último archivo de notación.
Primero copio el archivo a mi carpeta de notación. 

¡OJO! no se la pauta de lectura verdadera ni la hebra, así que estoy rellenando por defecto con ".", "-", ".". En caso de que se supiese se debería modificar esto. 

```{bash}
# Mi archivo es: /home/mlucena/grupolince/ultra_conserved_regions/lynx_coordinates_UCNE.bed

cd /GRUPOS/grupolince/Lyp_annotation_Apr14_final

awk -v OFS='\t' '{print $1,"manual","UCR",$2+1,$3,".", "-", ".", "ID="$4 }' /home/mlucena/grupolince/ultra_conserved_regions/lynx_coordinates_UCNE.bed > lynx_coordinates_UCNE.gff3

cat LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 lynx_coordinates_UCNE.gff3 > LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3

mkdir LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.PerScaffold 
cd LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.PerScaffold 

awk '{print >> $1; close($1)}' ../LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3


# Rename gff3.
for file in lp23*
do
echo $file
mv $file ${file/lp23/LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3_lp23}
done


```


      

# Some sanity

```{bash}

# Compruebo que está todo:

 awk '{print $3}'  LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3 | sort | uniq -c
# 5613 3UTR -->
#   5300 5UTR -->
# 182546 CDS -->
#  65795 intergenic -->
# 167874 intron -->
#   7823 intron_lncRNA -->
#  12141 lncRNA -->
#  12842 ncRNA -->
#   7389 promoter_gene_1000 -->
#   7389 promoter_gene_250 -->
#   7389 promoter_gene_500 -->
#   3174 promoter_lncRNA_1000 -->
#   3174 promoter_lncRNA_250 -->
#   3174 promoter_lncRNA_500 -->
#   5539 UCR -->
   
# Compruebo qu eno hay ninguna fila duplicada por completo:

sort LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3  | uniq -c | head
# 1 lp23.s00001	EVM_PASA	3UTR	10029244	10030485	.	-	.	ID=LYPA23C013663 -->
# 1 lp23.s00001	EVM_PASA	3UTR	10163213	10170531	.	+	.	ID=LYPA23C013777 -->
# 1 lp23.s00001	EVM_PASA	3UTR	10202693	10203508	.	+	.	ID=LYPA23C013856 -->
# 1 lp23.s00001	EVM_PASA	3UTR	102526	102823	.	+	.	ID=LYPA23C013712 -->
# 1 lp23.s00001	EVM_PASA	3UTR	10467000	10467605	.	+	.	ID=LYPA23C013816 -->
# 1 lp23.s00001	EVM_PASA	3UTR	10529811	10529946	.	-	.	ID=LYPA23C013675 -->
# 1 lp23.s00001	EVM_PASA	3UTR	10901088	10903936	.	-	.	ID=LYPA23C013674 -->
# 1 lp23.s00001	EVM_PASA	3UTR	1132661	1136959	.	+	.	ID=LYPA23C013667 -->
# 1 lp23.s00001	EVM_PASA	3UTR	11334610	11338061	.	-	.	ID=LYPA23C013747 -->
# 1 lp23.s00001	EVM_PASA	3UTR	11441195	11447165	.	+	.	ID=LYPA23C013724 -->


# Compruebo que están todas las bases que había definido como UCR:

grep UCR LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3 | awk '{sum+= $5-$4} END {print sum}'
# 1357904


# Comrpobamos que son todas las features uno based:

 awk '{print $4,NR}' LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.UCR.nr.gff3 | sort | head
 
# 1000009 252807
# 1000021 93511
# 1000025 320917
# 1000036 74215
# 1000046 314660
# 100005 199246

# Todo correcto!


```


#----------------------

#### Ojo!!!! Corrección

10/05/2018

He descubierto que las UCR caen en regiones que antes estaban definidas como intergénico. Así que tengo que redefinir intergénico en base a lo que ahora considero funcional. Para ello voy a pegar las UCR al archivo que tiene todo lo que es funcional. 

A partir de aquí repito y todos los archivos estarían bien.

## 4. Merging functional part of the genome 


```{bash}

# Este es mi archivo de cosas funcionales:
LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3

# Mi archivo de UCR es: lynx_coordinates_UCNE.gff3 que lo he generado arriba. 

cd /GRUPOS/grupolince/Lyp_annotation_Apr14_final

cat LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.gff3 lynx_coordinates_UCNE.gff3  | LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3
# Ya aprovecho y lo pongo ordenado que antes estaba desordenado. 

# Small sanity:

# grep -a3  UCR LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3 | head 
# lp23.s00001	MANUAL	intron	1305608	1346076	.	-	0	ID=LYPA23C013779T3_intron_6
# lp23.s00001	manual	UCR	1337649	1337953	.	-	.	ID=chr20_Charlie

# Echando un vistacillo parece que estas regiones solapan por ejemplo con intrones:
# Esto en principio no me preocuparía puesto que es real que pertenezcan a ambas categorías. El hecho de que aparezcan en intergénico no me gusta porque intergénico es una categoría por exclusión (lo que no es nada, es intergénico). 

# Otro sanity check:

cut -f 3 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3 | sort | uniq
# 3UTR
# 5UTR
# CDS
# gene
# intron
# intron_lncRNA
# lncRNA
# mRNA
# ncRNA
# promoter_gene_1000
# promoter_gene_250
# promoter_gene_500
# promoter_lncRNA_1000
# promoter_lncRNA_250
# promoter_lncRNA_500
# UCR


```


---> Sanity check para comprobar que cada archivo tiene lo que se espera de él. 

```{r, engine=bash, eval=FALSE}

# Miro a ver si nuestras construcciones ha provocado que algo se vaya más allá de cero. 

sort -nk 4,4 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3 | awk '($4<0){print $3}' | sort | uniq -c 
 
# OK!!! NADA! Esto es porque ya lo hemos solucionado con modificaciones del script arriba!!!


```

     
## 5. Defining intergenic regions

Fede tiene un bed de intergénico, pero dado que nosotros hemos:

1. Corregido los promotores que no estaban bien definidos para los genes -.
2. Añadido lncRNA (con promotores e intrones) y sncRNA

Por tanto, voy a usar mi file de funcional y restarle al genoma todas esas regiones. 

Vamos a construir dos tipos de regiones intergénicas:
1. Por un lado, tendríamos las regiones intergénicas que salen directamente de la resta del genoma menos la región funcional.
2. Por otro vamos a crear un intergénico que recoja las regiones que estén al menos a 1000pb de cualquier zona funcional. 


```{r, engine=bash, eval=FALSE}

# 1. 

# Por un lado, tendríamos las regiones intergénicas que salen directamente de la resta del genoma menos la región funcional.

# First create bed file based on the previous file. Como es un bed lo pasamos a es 0-based.

awk -v OFS='\t' '{print $1, $4-1, $5}' LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3 | bedtools merge -i stdin -d 1 > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.bed

#### ---> Sanity check:
# wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3
# 473867 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3

# wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.bed
# 32786 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.bed

# Sin los UCR solapaban más (abajo), lo que significa que muchos de los UCR caen en medio de intergénico alejado de todo!
# wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed
# 29799 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.nr.bed

##### 

# Define intergenic region 1-based!!

bedtools subtract -a /home/mlucena/grupolince/reference_genomes/lynx_pardinus_genome/bed_file_all_the_genome.bed -b LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.bed > LYPA23C.intergenic.bed

# 2. 

# Por otro vamos a crear un intergénico que recoja las regiones que estén al menos a 1000pb de cualquier zona funcional. 
# First create bed file based on the previous file. Como es un bed lo pasamos a es 0-based.

# con este awk sustituyo la columna que yo quiero por un valor concreto y el resto lo dejo igual. 

awk -v OFS='\t' '{$4=$4-1000; $5=$5+1000; print}' LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3 > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.PLUS1000bp.DO_NOT_USE.gff3

# Ojo! Este archivo es completamente artificial! Porque las unidades empiezan mil pares de bases antes de lo q deberían y acaban mil pares de bases despues, así que lo borro en cuanto lo use para no crear confusión. 

join -1 1 -2 1 <(cat /GRUPOS/grupolince/reference_genomes/lynx_pardinus_genome/Length_scaffolds_lp23)  <(LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.PLUS1000bp.DO_NOT_USE.gff3) | awk -v OFS='\t' '{if ($5<0) {$5="1"} else {$5=$5}; print}' | awk -v OFS='\t' '{if ($6>$2) {$6=$2} else {$6=$6}; print $1,$5-1,$6}' | bedtools merge -i stdin -d 1 > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.PLUS1000bp.DO_NOT_USE.bed

## Nota:Con este awk:
# awk -v OFS='\t' '{if ($5<0) {$5="1"} else {$5=$5}; print}' | awk -v OFS='\t' '{if ($6>$2) {$6=$2} else {$6=$6}; print $1,$5-1,$6}'
 # Lo que hago es mirar que nada se escape por debajo de 0 y si es así lo sustituyo por 1, lo que no se escapa se imprime igualmente. Además mira que nada sea más grande que el scaffold, y si es así, lo sustituyo por el valor de la longitud del scaffold, si no es más grande deja el mismo valor. En ambos casos, elimino del archivo el valor longitud de scaffold que está en columna 2 porque ya hemos hecho las comprobaciones que queremos. 
# También he guardado este archivito resultante de hacer estos awk e hice algunas comprobaciones. Concretamente miré que nada se escapaba por debajo de 0 en el límite superior y que nada se escapaba por encima de la longitud del scaffold. En definitiva, que el script funcionaba bien. 
# Este script además te imprime solo las columnas de las coordenadas en formato 0-based. 
# Si quisieras eliminar una columna, por ejemplo la 6: awk -v OFS='\t' '{if ($5<0) {$5="1"; $6=""} else {$5=$5; $6=""}; print}'

# Define strict intergenic region 1-based!!

bedtools subtract -a /home/mlucena/grupolince/reference_genomes/lynx_pardinus_genome/bed_file_all_the_genome.bed -b LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.PLUS1000bp.DO_NOT_USE.bed > LYPA23C.intergenic.PLUS1000.bed

# I need to create also a gff3 file with the intergenic, even thought it can be contraintuitive to have so (as gff3 have only functional features), but I need it to do all the numbers. I will used LYPA23C.intergenic.PLUS1000.bed to be sure of using intergenic regions (therefore there should be 1000pb between any functional category and the intergenic region for each individual feature).

awk -v OFS='\t' '{print $1,"manual","intergenic",$2+1,$3,".", "-", ".", "ID=intergenic_region_" }' LYPA23C.intergenic.PLUS1000.bed | awk -v OFS='\t' '{if ($3==prev) counter++; else counter=1; print ($1,$2,$3,$4,$5,$6,$7,$8,$9counter); prev=$3}'  > LYPA23C.intergenic.PLUS1000.gff3

# Nota! solo para que no nos sorprenda, en el tail de este archivo me he dado cuenta que hay un montón de scaffolds que no tienen ninguna anotación y por tanto son completamente intergénicos:
# lp23.s41697	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65792
# lp23.s41698	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65793
# lp23.s41699	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65794
# lp23.s41700	manual	intergenic	1	200	.	-	.	ID=intergenic_region_65795

rm *.DO_NOT_USE.*
```


## 6. Merging functional categories with intergenic gff3.


```{r, engine=bash, eval=FALSE}


# Now I merge it with the gff3 file.

cat LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.nr.gff3 LYPA23C.intergenic.PLUS1000.gff3 | LANG=en_EN sort -k 1,1 -k 4,4n -k 5,5n > LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3 

```

  
## 7. Creating the DATASET for diversity and folder per scaffold to speed up the process when calculating diversity per unit. 

```{bash}

# First I create the dataset to do diversity calculus. I remove Gene and mRNA.

wc -l LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3
541564 LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3

# ¡Cuidado con los tabs!

grep -v "EVM_PASA      gene" LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3 | grep -v "EVM_PASA        mRNA" | wc -l
499064

# I will compute way less sites, so I will use this file with no genes or mRNA. 
grep -v "EVM_PASA      gene" LYPA23C.GENE.mRNA.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3 | grep -v "EVM_PASA  mRNA" > LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3



# Now I will separate it by scaffolds. 
mkdir LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3.PerScaffold
cd LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3.PerScaffold

# Create multiple files base on one column: gff3:
awk '{print >> $1; close($1)}' ../LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3

# Rename gff3.
for file in lp23*
do
echo $file
mv $file ${file/lp23/LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3_lp23}
done



```


# ------------------------

# Resumen

Carpeta:


Archivos definitivos:

Hay dos archivos, uno:
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.intergenic.nr.gff3 creado antes de definir las UCR y usado para el paper de filogeografía

Y otro:
LYPA23C.CDS.GENE_promoters.GENE_introns.UTRs.ncRNA.lncRNA.lncRNA_introns.lncRNA_promoters.UCR.intergenic.nr.gff3 usado y creado para el paper de diversidad por unidad. 











  
